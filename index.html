<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Storm Chaser Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2 id="login-title">LOGIN</h2>
            <input type="text" id="userInput" placeholder="Usu√°rio">
            <input type="password" id="passInput" placeholder="Senha">
            <button onclick="authAction()" id="btnAuth">ENTRAR</button>
            <p onclick="toggleAuthMode()" id="toggleText">N√£o tem conta? Criar conta</p>
        </div>
    </div>

    <div id="top-bar">
        <div id="search-container">
            <input type="text" id="cityInput" placeholder="Pesquisar cidade...">
            <button onclick="buscarCidade()">üîç</button>
        </div>
        <button id="btn-menu-lateral" onclick="toggleMenu()">‚ò∞</button>
    </div>

    <div id="menu-lateral-65">
        <button class="btn-fechar-menu" onclick="toggleMenu()">‚úï</button>
        <div class="conteudo-menu">
            <div id="perfil-status">PLANO: <b id="userPlan">FREE</b></div>
            
            <button class="btn-menu-item" onclick="toggleSubMenu('lista-camadas')">üìÇ MULTICAMADAS</button>
            <div id="lista-camadas" class="sub-menu">
                <button onclick="setCamada('Default')">Padr√£o Infravermelho</button>
                <button onclick="setCamada('Satelite')">Sat√©lite HD</button>
                <button onclick="setCamada('StormChaser')" class="btn-storm">STORM CHASER (BAND 13)</button>
                <button onclick="toggleExtra('precipitation_new')">‚ö° DETEC√á√ÉO DE RAIOS</button>
                <button onclick="toggleExtra('wind_new')">üå¨Ô∏è VETORES DE VENTO</button>
                <button onclick="toggleExtra('clouds_new')">‚òÅÔ∏è NUVENS TOTAIS</button>
                </div>

            <button class="btn-menu-item" style="background:#gold; color:#000" onclick="abrirPlanos()">üíé UPGRADE ULTRA PRO</button>
        </div>
    </div>

    <div id="map"></div>
    <div id="painel-full"><button class="btn-fechar-full" onclick="fecharPainel()">‚úï</button><div id="conteudo-full" class="scroll-area"></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY = "SUA_API_KEY_OPENWEATHER";
        const map = L.map('map', { zoomControl: false, minZoom: 2 }).setView([-15, -47], 4);
        
        const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        
        let extras = {}; 
        let modoStorm = false;
        let camadaAlertas = L.layerGroup().addTo(map);

        function setCamada(tipo) {
            map.removeLayer(satLayer);
            const container = map.getContainer();
            container.style.filter = "none";
            
            if(tipo === 'StormChaser') {
                container.style.filter = "invert(100%) grayscale(100%) brightness(0.4) contrast(1.7)";
                modoStorm = true;
            } else if(tipo === 'Satelite') {
                satLayer.addTo(map);
                modoStorm = false;
            } else { modoStorm = false; }
            toggleMenu();
        }

        function toggleExtra(camadaID) {
            if(extras[camadaID]) { map.removeLayer(extras[camadaID]); delete extras[camadaID]; }
            else { 
                extras[camadaID] = L.tileLayer(`https://tile.openweathermap.org/map/${camadaID}/{z}/{x}/{y}.png?appid=${API_KEY}`, {zIndex: 500}).addTo(map);
            }
        }

        async function carregarAlertas() {
            const res = await fetch('/api/alertas');
            const data = await res.json();
            L.marker([-15.79, -47.88], { icon: L.divIcon({ html: 'üîÖ', className: 'emoji' }) }).addTo(camadaAlertas).on('click', () => mostrarListaAlertas(data.inmet, "INMET"));
            L.marker([38.89, -77.03], { icon: L.divIcon({ html: '‚òÅÔ∏è', className: 'emoji' }) }).addTo(camadaAlertas).on('click', () => mostrarListaAlertas(data.noaa, "NOAA", true));
        }

        async function processarClique(lat, lon) {
            const res = await fetch(`/api/clima-completo?lat=${lat}&lon=${lon}`);
            const data = await res.json();
            const c = data.clima.current;
            
            let html = `
                <h1>${data.geo.address.city || "Alvo"}</h1>
                <div class="temp-principal">${Math.round(c.temperature_2m)}¬∞C</div>
                <div class="info-grid">
                    <div class="info-card">Visibilidade: <b>${(c.visibility/1000).toFixed(1)}km</b></div>
                    <div class="info-card">P√¥r do Sol: <b>${data.clima.daily.sunset[0].split('T')[1]}</b></div>
                    <div class="info-card">Press√£o: <b>${c.pressure_msl}hPa</b></div>
                    <div class="info-card">Vento: <b>${c.wind_speed_10m}km/h</b></div>
                </div>`;

            if(modoStorm) {
                html += `
                <div class="painel-storm-chaser">
                    <h3>DADOS DE NUVEM BAND 13</h3>
                    <p><b>Nome:</b> ${data.geo.address.city || 'Nuvem Desconhecida'}</p>
                    <p><b>Tipo:</b> ${c.weather_code > 90 ? 'C√∫mulos-nimbos' : 'C√∫mulos'}</p>
                    <p><b>Data:</b> ${new Date().toLocaleTimeString()}</p>
                    <p><b>Altitude:</b> ${c.weather_code > 90 ? '15.000m' : '2.500m'}</p>
                    <p><b>Evolu√ß√£o:</b> ${c.weather_code > 90 ? 'C√∫mulos -> Superc√©lula' : 'C√∫mulos -> Est√°vel'}</p>
                </div>`;
            }
            abrirPainelFull(html, "#001a33");
        }

        // Fun√ß√µes de Interface (Menu, Login, etc)
        let isLogin = true;
        function toggleAuthMode() {
            isLogin = !isLogin;
            document.getElementById('login-title').innerText = isLogin ? "LOGIN" : "CRIAR CONTA";
            document.getElementById('btnAuth').innerText = isLogin ? "ENTRAR" : "CADASTRAR";
            document.getElementById('toggleText').innerText = isLogin ? "N√£o tem conta? Criar conta" : "J√° tem conta? Entrar";
        }

        async function authAction() {
            const user = document.getElementById('userInput').value;
            const pass = document.getElementById('passInput').value;
            const route = isLogin ? '/api/login' : '/api/cadastro';
            const res = await fetch(route, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user, pass}) });
            if(res.ok) {
                if(!isLogin) { alert("Conta criada! Agora fa√ßa login."); toggleAuthMode(); }
                else { 
                    const data = await res.json();
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('userPlan').innerText = data.plan;
                    carregarAlertas();
                }
            } else alert("Erro na autentica√ß√£o.");
        }

        function toggleMenu() { document.getElementById('menu-lateral-65').classList.toggle('menu-active'); }
        function toggleSubMenu(id) { document.getElementById(id).classList.toggle('active'); }
        function abrirPainelFull(h, bg) { document.getElementById('painel-full').style.background = bg; document.getElementById('conteudo-full').innerHTML = h; document.getElementById('painel-full').classList.add('active'); }
        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }
        map.on('click', e => processarClique(e.latlng.lat, e.latlng.lng));
    </script>
</body>
</html>
