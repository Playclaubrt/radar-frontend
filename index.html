<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaser Monitor v3</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="search-container">
        <input type="text" id="input-busca" placeholder="Pesquisar cidade...">
        <button onclick="buscarLocalizacao()">ğŸ”</button>
    </div>

    <div id="container-controles">
        <button id="btn-menu" onclick="toggleMenu()">â˜° MENU CAMADAS</button>
        <button id="btn-ativar-alertas" onclick="renderizarIconesNosMapas()">ğŸ”… ATIVAR ALERTAS â˜ï¸</button>
    </div>

    <div id="menu-lateral">
        <button onclick="toggleMenu()" class="btn-fechar">âœ• FECHAR</button>
        <div class="cat-title">SATÃ‰LITE OWM</div>
        <button class="btn-layer" onclick="aplicarCamada('clouds')">â˜ï¸ Nuvens Real</button>
        <button class="btn-layer" onclick="aplicarCamada('infra')">ğŸŒ¡ï¸ Infravermelho (RealÃ§ado)</button>
        <div class="cat-title">RADAR E MAPA</div>
        <button class="btn-layer" onclick="aplicarCamada('tempestades')">â›ˆï¸ Radar de Chuva</button>
        <button class="btn-layer" onclick="aplicarCamada('satelite_base')">ğŸ›°ï¸ VisÃ£o de SatÃ©lite</button>
    </div>

    <div id="map"></div>

    <div id="painel-full">
        <button class="btn-close-full" onclick="fecharPainel()">âœ•</button>
        <div id="painel-content"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY_OWM = "7609a59c493758162d9b0a6af2914e1f"; 
        const map = L.map('map', { zoomControl: false }).setView([-15.79, -47.88], 3);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let layerAtiva = null;
        let markersAlertas = [];

        // CRIA OS ÃCONES INDIVIDUAIS NO MAPA MUNDI
        async function renderizarIconesNosMapas() {
            markersAlertas.forEach(m => map.removeLayer(m));
            markersAlertas = [];

            const res = await fetch('/api/alertas');
            const data = await res.json();

            // Ãcone INMET em BrasÃ­lia
            const iconInmet = L.divIcon({ html: 'ğŸ”…', className: 'map-icon-alerta', iconSize: [30, 30] });
            const mInmet = L.marker([-15.79, -47.88], { icon: iconInmet }).addTo(map);
            mInmet.on('click', () => mostrarPainelAlerta('INMET BRASIL', data.inmet));
            
            // Ãcone NOAA em Washington
            const iconNoaa = L.divIcon({ html: 'â˜ï¸', className: 'map-icon-alerta', iconSize: [30, 30] });
            const mNoaa = L.marker([38.89, -77.03], { icon: iconNoaa }).addTo(map);
            mNoaa.on('click', () => mostrarPainelAlerta('NOAA USA', data.noaa));

            markersAlertas.push(mInmet, mNoaa);
            alert("Ãcones de Alerta posicionados no Mapa Mundi.");
        }

        function mostrarPainelAlerta(titulo, lista) {
            let html = `<h1>${titulo}</h1>`;
            if(!lista || lista.length === 0) html += "<p>Sem alertas crÃ­ticos no momento.</p>";
            else {
                lista.forEach(item => {
                    html += `<div class="alerta-card"><h3>${item.title || item.properties.event}</h3><p>${item.description || item.properties.headline}</p></div><hr>`;
                });
            }
            document.getElementById('painel-content').innerHTML = html;
            document.getElementById('painel-full').className = 'alerta-view active';
        }

        function aplicarCamada(tipo) {
            if(layerAtiva) map.removeLayer(layerAtiva);
            let url = "";
            if(tipo === 'clouds') url = `https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
            if(tipo === 'infra') url = `https://tile.openweathermap.org/map/pressure_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
            if(tipo === 'tempestades') url = 'https://tilecache.rainviewer.com/v2/radar/nowcast_5/256/{z}/{x}/{y}/2/1_1.png';
            if(tipo === 'satelite_base') url = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
            
            if(url) layerAtiva = L.tileLayer(url, { opacity: 0.8, zIndex: 100 }).addTo(map);
            toggleMenu();
        }

        map.on('click', async (e) => {
            if (e.originalEvent.target.classList.contains('leaflet-marker-icon')) return;
            const res = await fetch(`/api/clima-clique?lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
            const d = await res.json();

            document.getElementById('painel-content').innerHTML = `
                <div class="clima-header">
                    <h1>${d.geo.address.city || "LocalizaÃ§Ã£o"}</h1>
                    <div class="temp-val">${Math.round(d.clima.current.temp)}Â°C</div>
                </div>
                <div class="clima-grid">
                    <div class="c-item">ğŸ’§ Umidade: ${d.clima.current.humidity}%</div>
                    <div class="c-item">ğŸŒ¬ï¸ Vento: ${d.clima.current.wind_speed} km/h</div>
                    <div class="c-item">ğŸƒ Ar (AQI): ${d.poluicao.list[0].main.aqi}</div>
                    <div class="c-item">ğŸ‘ï¸ Visib.: ${d.clima.current.visibility / 1000}km</div>
                    <div class="c-item">â²ï¸ PressÃ£o: ${d.clima.current.pressure}hPa</div>
                    <div class="c-item">ğŸŒ… Nascer: ${new Date(d.clima.current.sunrise * 1000).toLocaleTimeString()}</div>
                    <div class="c-item">ğŸŒ‡ PÃ´r do Sol: ${new Date(d.clima.current.sunset * 1000).toLocaleTimeString()}</div>
                </div>
            `;
            document.getElementById('painel-full').className = 'clima-view active';
        });

        function toggleMenu() { document.getElementById('menu-lateral').classList.toggle('active'); }
        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }
        async function buscarLocalizacao() {
            const q = document.getElementById('input-busca').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
            const data = await res.json();
            if(data[0]) map.setView([data[0].lat, data[0].lon], 10);
        }
    </script>
</body>
</html>
