<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaser Monitor v3 - Global</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="search-container">
        <input type="text" id="input-busca" placeholder="Pesquisar cidade...">
        <button onclick="buscarLocalizacao()">üîç</button>
    </div>

    <div id="container-controles">
        <button id="btn-menu" onclick="toggleMenu()">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </button>
        <button id="btn-ativar-alertas" onclick="renderizarIconesNosMapas()">üîÖ ATIVAR ALERTAS ‚òÅÔ∏è</button>
    </div>

    <div id="menu-lateral">
        <button onclick="toggleMenu()" class="btn-fechar">‚úï</button>
        <div class="cat-title">ATMOSFERA</div>
        <button class="btn-layer" onclick="aplicarCamada('clouds')">‚òÅÔ∏è Nuvens Reais</button>
        <button class="btn-layer" onclick="aplicarCamada('infra')">üå°Ô∏è Infravermelho</button>
        <div class="cat-title">RADAR</div>
        <button class="btn-layer" onclick="aplicarCamada('tempestades')">‚õàÔ∏è Radar de Chuva</button>
        <button class="btn-layer" onclick="aplicarCamada('satelite_base')">üõ∞Ô∏è Sat√©lite</button>
    </div>

    <div id="map"></div>

    <div id="painel-full">
        <button class="btn-close-full" onclick="fecharPainel()">‚úï</button>
        <div id="painel-content">
            </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CONFIGURA√á√ÉO ---
const API_KEY_OWM = "7609a59c493758162d9b0a6af2914e1f"; 

// 1. ADICIONADO BARREIRAS (MAX BOUNDS) PARA N√ÉO IR PRO FIM DO MAPA
const southWest = L.latLng(-89.98, -179.99),
      northEast = L.latLng(89.98, 179.99),
      bounds = L.latLngBounds(southWest, northEast);

const map = L.map('map', { 
    zoomControl: false, 
    attributionControl: false,
    maxBounds: bounds,         // Trava o mapa nos limites do mundo
    maxBoundsViscosity: 1.0,    // Impede de arrastar para fora
    minZoom: 3,                 // N√£o deixa dar muito zoom out
    maxZoom: 18                 // Limita o zoom in
}).setView([-22.12, -51.38], 10);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    noWrap: true               // Impede o mapa de ficar repetindo infinitamente
}).addTo(map);

let camadaAtual = 'default';
let layerAtiva = null;

// --- CLIQUE NA TELA (S√ì ABRE O PAINEL, SEM AVISOS) ---
map.on('click', async (e) => {
    if (e.originalEvent.target.classList.contains('map-icon')) return;
    const { lat, lng } = e.latlng;

    const painel = document.getElementById('painel-full');
    
    try {
        const res = await fetch(`/api/clima-clique?lat=${lat}&lng=${lng}`);
        const d = await res.json();
        
        // Se der erro ou n√£o vier dado, o JS sai fora e n√£o mostra mensagem nenhuma
        if (!d || !d.clima) return;

        let camadaInfo = "";
        if(camadaAtual === 'tempestades') {
            camadaInfo = `<div class="analise-box"><h2>‚õàÔ∏è RADAR</h2><p>Precipita√ß√£o: ${d.clima.current.rain ? d.clima.current.rain['1h'] : '0.0'} mm/s</p></div>`;
        }

        document.getElementById('painel-content').innerHTML = `
            <div class="clima-section">
                <h1>${d.geo.address.city || d.geo.address.town || "Localiza√ß√£o"}</h1>
                <div class="temp-val">${Math.round(d.clima.current.temp)}¬∞C</div>
                <div class="clima-grid">
                    <div class="c-item">üíß Umidade: ${d.clima.current.humidity}%</div>
                    <div class="c-item">üå¨Ô∏è Vento: ${d.clima.current.wind_speed} km/h</div>
                </div>
                ${camadaInfo}
            </div>
        `;
        painel.className = 'clima-view active';
    } catch (err) {
        // Se cair a net ou der erro, o painel simplesmente n√£o abre. Fica "mudo".
        return;
    }
});

// --- BUSCA CORRIGIDA (AGORA ELA MOVE O MAPA DE VERDADE) ---
async function buscarLocalizacao() {
    const q = document.getElementById('input-busca').value;
    if(!q) return;

    try {
        // Usando o servi√ßo de geocoding do OpenStreetMap
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
        const data = await res.json();
        
        if(data && data.length > 0) {
            const local = data[0];
            map.setView([local.lat, local.lon], 12); // Move a c√¢mera para a cidade buscada
        }
    } catch(e) {
        console.error("Busca falhou");
    }
}

// Permitir busca ao apertar "Enter"
document.getElementById('input-busca').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        buscarLocalizacao();
    }
});

// Fun√ß√µes de Menu e Alertas (mantidas conforme as anteriores)
function toggleMenu() { document.getElementById('menu-lateral').classList.toggle('active'); }
function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }
function aplicarCamada(tipo) {
    camadaAtual = tipo;
    if(layerAtiva) map.removeLayer(layerAtiva);
    let url = "";
    if(tipo === 'clouds') url = `https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
    if(tipo === 'infra') url = `https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
    if(tipo === 'tempestades') url = `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
    if(url) layerAtiva = L.tileLayer(url, { opacity: 0.85, zIndex: 100 }).addTo(map);
    toggleMenu();
        }    
    </script>
</body>
</html>
