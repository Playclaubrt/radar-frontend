<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="search-container">
        <input type="text" id="input-busca" placeholder="Pesquisar cidade...">
        <button onclick="buscarLocalizacao()">ğŸ”</button>
    </div>

    <div id="container-controles">
        <button id="btn-menu" onclick="toggleMenu()"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
        <button id="btn-ativar-alertas" onclick="renderizarIconesNosMapas()">ğŸ”… ATIVAR ALERTAS â˜ï¸</button>
    </div>

    <div id="menu-lateral">
        <button class="btn-layer" onclick="aplicarCamada('clouds')">â˜ï¸ Nuvens</button>
        <button class="btn-layer" onclick="aplicarCamada('infra')">ğŸŒ¡ï¸ Infravermelho</button>
        <button class="btn-layer" onclick="aplicarCamada('tempestades')">â›ˆï¸ Radar</button>
        <button class="btn-layer" onclick="aplicarCamada('satelite_base')">ğŸ›°ï¸ SatÃ©lite</button>
    </div>

    <div id="map"></div>

    <div id="painel-full">
        <button class="btn-close" onclick="this.parentElement.classList.remove('active')">âœ•</button>
        <div id="alertas-content" class="painel-content"></div>
    </div>

    <div id="painel-clima">
        <button class="btn-close" onclick="this.parentElement.classList.remove('active')">âœ•</button>
        <div id="painel-content" class="painel-content"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY = "7609a59c493758162d9b0a6af2914e1f";
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-22.12, -51.38], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let layerAtiva = null;

        function aplicarCamada(tipo) {
            if(layerAtiva) map.removeLayer(layerAtiva);
            let url = "";
            if(tipo === 'clouds') url = `https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${API_KEY}`;
            if(tipo === 'infra') url = `https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${API_KEY}`;
            if(tipo === 'tempestades') url = `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${API_KEY}`;
            if(tipo === 'satelite_base') url = 'http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}';
            if(url) layerAtiva = L.tileLayer(url, { opacity: 0.8, subdomains:['mt0','mt1','mt2','mt3'] }).addTo(map);
            toggleMenu();
        }

        async function buscarLocalizacao() {
            const q = document.getElementById('input-busca').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
            const d = await res.json();
            if(d[0]) map.setView([d[0].lat, d[0].lon], 12);
        }

        async function renderizarIconesNosMapas() {
            const res = await fetch('/api/alertas');
            const data = await res.json();
            L.marker([-15.79, -47.88], {icon: L.divIcon({html:'ğŸ”…', className:'map-icon'})}).addTo(map).on('click', () => {
                document.getElementById('alertas-content').innerHTML = `<h1>ALERTAS INMET</h1>` + data.inmet.map(i => `<div style="text-align:left; background:#222; padding:20px; margin-top:10px; border-left:5px solid #ffcc00"><h3>${i.title}</h3><p>${i.description}</p></div>`).join('');
                document.getElementById('painel-full').classList.add('active');
            });
        }

        function toggleMenu() { document.getElementById('menu-lateral').classList.toggle('active'); }
        function getClimaEmoji(code) { return "â˜€ï¸"; } // Simplificado

        // --- CLIQUE NO MAPA (O SEU CÃ“DIGO EXATO) ---
        map.on('click', async (e) => { // 1. Ouve o clique no mapa
            // 2. Faz o pedido ao seu Server.js enviando a Latitude e Longitude de onde vocÃª clicou
            const res = await fetch(`/api/clima-clique?lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
            const data = await res.json();
            
            const cur = data.clima.current;
            const dai = data.clima.daily;

            // 3. Insere as informaÃ§Ãµes dentro da div "painel-content"
            document.getElementById('painel-content').innerHTML = `
                <h1 style="margin:0">${data.geo.address.city || data.geo.address.town || "LocalizaÃ§Ã£o"}</h1>
                <div style="font-size:90px; margin:10px 0">${getClimaEmoji(cur.weather_code)}</div>
                <div class="temp-txt">${cur.temp.toFixed(1)}Â°C</div>
                
                <div class="grid-clima">
                    <div class="item-c">ğŸ’§ Umidade<br><b>${cur.humidity}%</b></div>
                    <div class="item-c">ğŸŒ¬ï¸ Ventos<br><b>${cur.wind_speed}km/h</b></div>
                    <div class="item-c">â²ï¸ PressÃ£o<br><b>${cur.pressure}hPa</b></div>
                    <div class="item-c">ğŸŒ‡ PÃ´r do Sol<br><b>${new Date(cur.sunset * 1000).toLocaleTimeString()}</b></div>
                    <div class="item-c">ğŸŒ… Nascer do Sol<br><b>${new Date(cur.sunrise * 1000).toLocaleTimeString()}</b></div>
                    <div class="item-c">ğŸƒ Ar<br><b>${data.poluicao.list[0].main.aqi} AQI</b></div>
                    <div class="item-c">ğŸ‘ï¸ Visibilidade<br><b>${cur.visibility / 1000}km</b></div>
                </div>
                `;

            // 4. ATIVA O PAINEL (Muda a posiÃ§Ã£o dele no CSS de 100% para 0)
            document.getElementById('painel-clima').classList.add('active');
        });
    </script>
</body>
</html>
