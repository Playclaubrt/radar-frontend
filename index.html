<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaser Monitor v3 - Global</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="search-container">
        <input type="text" id="input-busca" placeholder="Pesquisar cidade...">
        <button onclick="buscarLocalizacao()">üîç</button>
    </div>

    <div id="container-controles">
        <button id="btn-menu" onclick="toggleMenu()">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </button>
        <button id="btn-ativar-alertas" onclick="renderizarIconesNosMapas()">üîÖ ATIVAR ALERTAS ‚òÅÔ∏è</button>
    </div>

    <div id="menu-lateral">
        <button onclick="toggleMenu()" class="btn-fechar">‚úï</button>
        <div class="cat-title">ATMOSFERA</div>
        <button class="btn-layer" onclick="aplicarCamada('clouds')">‚òÅÔ∏è Nuvens Reais</button>
        <button class="btn-layer" onclick="aplicarCamada('infra')">üå°Ô∏è Infravermelho</button>
        <div class="cat-title">RADAR</div>
        <button class="btn-layer" onclick="aplicarCamada('tempestades')">‚õàÔ∏è Radar de Chuva</button>
        <button class="btn-layer" onclick="aplicarCamada('satelite_base')">üõ∞Ô∏è Sat√©lite</button>
    </div>

    <div id="map"></div>

    <div id="painel-full">
        <button class="btn-close-full" onclick="fecharPainel()">‚úï</button>
        <div id="painel-content">
            </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CONFIGURA√á√ÉO ---
        const API_KEY_OWM = "7609a59c493758162d9b0a6af2914e1f"; // COLOQUE SUA CHAVE AQUI
        
        const map = L.map('map', { 
            zoomControl: false, 
            attributionControl: false 
        }).setView([-22.12, -51.38], 10); // Inicia em Prudente

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let camadaAtual = 'default';
        let layerAtiva = null;
        let markersAlertas = [];

        // --- FUN√á√ïES DE CAMADAS ---
        function aplicarCamada(tipo) {
            camadaAtual = tipo;
            if(layerAtiva) map.removeLayer(layerAtiva);
            
            let url = "";
            if(tipo === 'clouds') url = `https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
            if(tipo === 'infra') url = `https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
            if(tipo === 'tempestades') url = `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
            if(tipo === 'satelite_base') url = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
            
            if(url) {
                layerAtiva = L.tileLayer(url, { opacity: 0.85, zIndex: 100 }).addTo(map);
            }
            toggleMenu();
        }

        // --- CLIQUE NO MAPA (ABRE PAINEL AZUL) ---
        map.on('click', async (e) => {
            // Se clicar num marcador de alerta, n√£o abre o clima
            if (e.originalEvent.target.classList.contains('map-icon')) return;

            const { lat, lng } = e.latlng;
            
            // Ativa o painel imediatamente (Feedback visual)
            const painel = document.getElementById('painel-full');
            document.getElementById('painel-content').innerHTML = "<h1 style='margin-top:100px'>Obtendo Relat√≥rio Atmosf√©rico...</h1>";
            painel.className = 'clima-view active';

            try {
                const res = await fetch(`/api/clima-clique?lat=${lat}&lon=${lng}`);
                const d = await res.json();
                
                // L√≥gica de an√°lise da camada atual
                let camadaInfo = "";
                if(camadaAtual === 'tempestades') {
                    camadaInfo = `<div class="analise-box"><h2>‚õàÔ∏è DADOS DO RADAR</h2><p><b>Precipita√ß√£o:</b> ${d.clima.current.rain ? d.clima.current.rain['1h'] : '0.0'} mm/s</p><p><b>Estado:</b> Detec√ß√£o de part√≠culas de √°gua em suspens√£o.</p></div>`;
                } else if(camadaAtual === 'clouds') {
                    camadaInfo = `<div class="analise-box"><h2>‚òÅÔ∏è NUVENS REAIS</h2><p><b>Cobertura:</b> ${d.clima.current.clouds}%</p><p><b>Altitude:</b> Nuvens de n√≠vel M√©dio/Baixo</p><p><b>Dire√ß√£o:</b> Deslocamento a ${d.clima.current.wind_deg}¬∞</p></div>`;
                } else if(camadaAtual === 'infra') {
                    camadaInfo = `<div class="analise-box"><h2>üå°Ô∏è INFRAVERMELHO</h2><p><b>Assinatura T√©rmica:</b> ${d.clima.current.temp > 25 ? 'ALTA' : 'EST√ÅVEL'}</p><p><b>Velocidade:</b> ${d.clima.current.wind_speed} km/h</p></div>`;
                } else if(camadaAtual === 'satelite_base') {
                    camadaInfo = `<div class="analise-box"><h2>üõ∞Ô∏è AN√ÅLISE GEOGR√ÅFICA</h2><p><b>Solo:</b> Classifica√ß√£o via espectro vis√≠vel</p><p><b>Relevo:</b> An√°lise de sombreamento de terreno ativa.</p></div>`;
                }

                document.getElementById('painel-content').innerHTML = `
                    <div class="clima-section">
                        <h1>${d.geo.address.city || d.geo.address.town || d.geo.address.village || "Ponto Geogr√°fico"}</h1>
                        <div class="temp-val">${Math.round(d.clima.current.temp)}¬∞C</div>
                        <div class="clima-grid">
                            <div class="c-item">üíß Umidade: ${d.clima.current.humidity}%</div>
                            <div class="c-item">üå¨Ô∏è Vento: ${d.clima.current.wind_speed} km/h</div>
                            <div class="c-item">üçÉ Qualidade Ar: ${d.poluicao.list[0].main.aqi} AQI</div>
                            <div class="c-item">üëÅÔ∏è Visib: ${d.clima.current.visibility / 1000}km</div>
                            <div class="c-item">‚è≤Ô∏è Press√£o: ${d.clima.current.pressure}hPa</div>
                            <div class="c-item">üåá P√¥r do sol: ${new Date(d.clima.current.sunset * 1000).toLocaleTimeString()}</div>
                        </div>
                        <div style="height:30px"></div>
                        ${camadaInfo}
                        <div style="height:50px"></div>
                    </div>
                `;
            } catch (err) {
                document.getElementById('painel-content').innerHTML = "<h1>Erro de Conex√£o.</h1><p>Verifique sua API Key ou Internet.</p>";
            }
        });

        // --- ALERTAS (INMET / NOAA) ---
        async function renderizarIconesNosMapas() {
            markersAlertas.forEach(m => map.removeLayer(m));
            const res = await fetch('/api/alertas');
            const data = await res.json();

            // Brasil
            const mInmet = L.marker([-15.79, -47.88], { icon: L.divIcon({html:'üîÖ', className:'map-icon'}) }).addTo(map);
            mInmet.on('click', () => abrirAlerta('INMET BRASIL', data.inmet));

            // USA
            const mNoaa = L.marker([38.89, -77.03], { icon: L.divIcon({html:'‚òÅÔ∏è', className:'map-icon'}) }).addTo(map);
            mNoaa.on('click', () => abrirAlerta('NOAA USA', data.noaa));

            markersAlertas.push(mInmet, mNoaa);
            alert("Sistemas de monitoramento de alertas ativados!");
        }

        function abrirAlerta(f, l) {
            let h = `<h1>${f}</h1>`;
            if(l.length === 0) h += "<p>Nenhum alerta cr√≠tico no momento.</p>";
            l.forEach(i => {
                h += `<div class="analise-box"><h3>${i.title || i.properties.event}</h3><p>${i.description || i.properties.headline}</p></div>`;
            });
            document.getElementById('painel-content').innerHTML = h;
            document.getElementById('painel-full').className = 'alerta-view active';
        }

        // --- UTILIT√ÅRIOS ---
        function toggleMenu() { document.getElementById('menu-lateral').classList.toggle('active'); }
        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }
        
        async function buscarLocalizacao() {
            const q = document.getElementById('input-busca').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
            const data = await res.json();
            if(data[0]) map.setView([data[0].lat, data[0].lon], 11);
        }
    </script>
</body>
</html>
