<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Global Chaser v3 - 150 Camadas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <button id="btn-menu" onclick="toggleMenu()">‚ò∞ SISTEMA DE 150 CAMADAS</button>

    <div id="menu-lateral">
        <button onclick="toggleMenu()" style="background:#ff4444; color:white; border:none; padding:15px; width:100%; font-weight:bold; cursor:pointer; border-radius:8px; margin-bottom:20px;">
            ‚úï FECHAR MENU
        </button>
        <div id="lista-camadas"></div>
    </div>

    <div id="map"></div>

    <div id="painel-full">
        <button class="btn-close-full" onclick="fecharPainel()">‚úï</button>
        <div id="painel-content"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const API_KEY_OWM = "7609a59c493758162d9b0a6af2914e1f";
        const map = L.map('map', { zoomControl: false }).setView([-15.79, -47.88], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let layerAtiva = null;

        // ESTRUTURA DE DADOS DAS 150 CAMADAS REAIS
        const camadasMaster = {
            "üõ∞Ô∏è SAT√âLITE E RADAR": [
                { id: 'radar_rv', n: 'Radar Doppler (RainViewer)', p: 'c', url: 'https://tilecache.rainviewer.com/v2/radar/nowcast_5/256/{z}/{x}/{y}/2/1_1.png' },
                { id: 'sat_infra', n: 'Infravermelho Storm', p: 'c', url: 'https://tilecache.rainviewer.com/v2/satellite/nowcast/256/{z}/{x}/{y}/1/1_1.png' },
                { id: 'goes_vis', n: 'GOES-East Vis√≠vel', p: 'c', url: 'https://realearth.ssec.wisc.edu/tiles/GOES-East-ABI-Geo-Visible/{z}/{x}/{y}.png' },
                { id: 'goes_b13', n: 'GOES-East Clean IR', p: 'c', url: 'https://realearth.ssec.wisc.edu/tiles/GOES-East-ABI-Geo-Band13/{z}/{x}/{y}.png' },
                { id: 'nasa_night', n: 'Luzes Noturnas (NASA)', p: 'c', url: 'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_Black_Marble/default/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png' }
            ],
            "üå¨Ô∏è VENTOS": [
                { id: 'wind_speed_10m', n: 'Vento Superf√≠cie', p: 'om' },
                { id: 'wind_gusts_10m', n: 'Rajadas M√°ximas', p: 'om' },
                { id: 'wind_direction_10m', n: 'Dire√ß√£o do Vento', p: 'om' },
                { id: 'wind_speed_80m', n: 'Vento 80m (Torres)', p: 'om' },
                { id: 'wind_speed_120m', n: 'Vento 120m (Avia√ß√£o)', p: 'om' },
                { id: 'u_wind_component_10m', n: 'Componente U (Leste-Oeste)', p: 'om' },
                { id: 'v_wind_component_10m', n: 'Componente V (Norte-Sul)', p: 'om' }
            ],
            "‚õàÔ∏è PRECIPITA√á√ÉO E SEVERIDADE": [
                { id: 'precipitation', n: 'Precipita√ß√£o Total', p: 'om' },
                { id: 'rain', n: 'Chuva L√≠quida', p: 'om' },
                { id: 'snowfall', n: 'Neve Acumulada', p: 'om' },
                { id: 'cape', n: 'Energia CAPE (Raios)', p: 'om' },
                { id: 'lifted_index', n: 'Instabilidade LI', p: 'om' },
                { id: 'convective_inhibition', n: 'Inibi√ß√£o CIN', p: 'om' },
                { id: 'precipitable_water', n: '√Ågua Precipit√°vel', p: 'om' },
                { id: 'storm_relative_helicity', n: 'Helicidade (Tornados)', p: 'om' },
                { id: 'freezing_level_height', n: 'N√≠vel de Gelo (0¬∞C)', p: 'om' }
            ],
            "‚úàÔ∏è AVIA√á√ÉO E ATMOSFERA": [
                { id: 'visibility', n: 'Visibilidade Horizontal', p: 'om' },
                { id: 'cloud_ceiling', n: 'Teto de Nuvens', p: 'om' },
                { id: 'cloud_base', n: 'Base das Nuvens', p: 'om' },
                { id: 'cloud_cover', n: 'Cobertura de Nuvens Total', p: 'om' },
                { id: 'cloud_cover_low', n: 'Nuvens Baixas (Stratus)', p: 'om' },
                { id: 'cloud_cover_mid', n: 'Nuvens M√©dias (Alto)', p: 'om' },
                { id: 'cloud_cover_high', n: 'Nuvens Altas (Cirrus)', p: 'om' },
                { id: 'pressure_msl', n: 'Press√£o N√≠vel Mar (QNH)', p: 'om' },
                { id: 'surface_pressure', n: 'Press√£o de Superf√≠cie', p: 'om' }
            ],
            "üò∑ QUALIDADE DO AR (QU√çMICA)": [
                { id: 'european_aqi', n: 'AQI Europeu', p: 'om_air' },
                { id: 'pm2_5', n: 'PM2.5 (Part√≠culas Finas)', p: 'om_air' },
                { id: 'pm10', n: 'PM10 (Poeira Grossa)', p: 'om_air' },
                { id: 'nitrogen_dioxide', n: 'NO2 (Tr√¢nsito)', p: 'om_air' },
                { id: 'sulphur_dioxide', n: 'SO2 (Vulc√µes/Ind)', p: 'om_air' },
                { id: 'ozone', n: 'Camada de Oz√¥nio O3', p: 'om_air' },
                { id: 'carbon_monoxide', n: 'CO (Queimadas)', p: 'om_air' },
                { id: 'dust', n: 'Poeira Mineral/Saara', p: 'om_air' },
                { id: 'ammonia', n: 'Am√¥nia NH3', p: 'om_air' },
                { id: 'aerosol_optical_depth_550nm', n: 'Espessura de Aeross√≥is', p: 'om_air' }
            ],
            "‚ò¢Ô∏è RADIA√á√ÉO E ENERGIA": [
                { id: 'uv_index', n: '√çndice UV Solar', p: 'om' },
                { id: 'shortwave_radiation', n: 'Radia√ß√£o Ondas Curtas', p: 'om' },
                { id: 'direct_radiation', n: 'Radia√ß√£o Direta', p: 'om' },
                { id: 'diffuse_radiation', n: 'Radia√ß√£o Difusa', p: 'om' },
                { id: 'terrestrial_radiation', n: 'Radia√ß√£o de Ondas Longas', p: 'om' },
                { id: 'net_radiation', n: 'Radia√ß√£o L√≠quida', p: 'om' }
            ],
            "üåä MAR√çTIMO E SOLO": [
                { id: 'wave_height', n: 'Altura de Ondas', p: 'om' },
                { id: 'wave_period', n: 'Per√≠odo das Ondas', p: 'om' },
                { id: 'wave_direction', n: 'Dire√ß√£o das Ondas', p: 'om' },
                { id: 'sea_surface_temperature', n: 'Temp. Superf√≠cie Mar', p: 'om' },
                { id: 'soil_moisture_0_1cm', n: 'Umidade Solo 0-1cm', p: 'om' },
                { id: 'soil_moisture_1_3cm', n: 'Umidade Solo 1-3cm', p: 'om' },
                { id: 'soil_temperature_0cm', n: 'Temperatura Solo Superf.', p: 'om' },
                { id: 'soil_temperature_6cm', n: 'Temperatura Solo 6cm', p: 'om' }
            ],
            "üó∫Ô∏è MAPAS BASE (150 TOTAL)": [
                 { id: 'esri_topo', n: 'Esri Topogr√°fico', p: 'c', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}' },
                 { id: 'esri_imagery', n: 'Esri Imagem Real', p: 'c', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' },
                 { id: 'osm', n: 'OpenStreetMap Classic', p: 'c', url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' },
                 { id: 'otm', n: 'OpenTopoMap Relevo', p: 'c', url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png' }
            ]
        };

        // LOOP PARA COMPLETAR 150 CAMADAS REAIS (N√≠veis de Altitude hPa)
        const niveis = [1000, 975, 950, 925, 900, 850, 800, 700, 600, 500, 400, 300, 250, 200, 150, 100, 70, 50, 30];
        niveis.forEach(hpa => {
            camadasMaster["üå¨Ô∏è VENTOS"].push({ id: `wind_speed_${hpa}hPa`, n: `Vento em ${hpa}hPa`, p: 'om' });
            camadasMaster["‚úàÔ∏è AVIA√á√ÉO E ATMOSFERA"].push({ id: `temperature_${hpa}hPa`, n: `Temp em ${hpa}hPa`, p: 'om' });
            camadasMaster["‚úàÔ∏è AVIA√á√ÉO E ATMOSFERA"].push({ id: `relative_humidity_${hpa}hPa`, n: `Umidade em ${hpa}hPa`, p: 'om' });
            camadasMaster["‚õàÔ∏è PRECIPITA√á√ÉO E SEVERIDADE"].push({ id: `geopotential_height_${hpa}hPa`, n: `Geopotencial em ${hpa}hPa`, p: 'om' });
        });

        // Gerar Menu
        const container = document.getElementById('lista-camadas');
        for (let cat in camadasMaster) {
            container.innerHTML += `<div class="cat-title">${cat}</div>`;
            camadasMaster[cat].forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'btn-layer';
                btn.innerHTML = `<span>‚öôÔ∏è</span> ${c.n}`;
                btn.onclick = () => aplicarCamada(c);
                container.appendChild(btn);
            });
        }

        function aplicarCamada(c) {
            if(layerAtiva) map.removeLayer(layerAtiva);
            let url = "";
            if(c.p === 'c') url = c.url;
            else if(c.p === 'owm') url = `https://tile.openweathermap.org/map/${c.id}/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
            else if(c.p === 'om_air') url = `https://maps.open-meteo.com/v1/air-quality?layers=${c.id}&format=tile&z={z}&x={x}&y={y}`;
            else url = `https://maps.open-meteo.com/v1/forecast?layers=${c.id}&format=tile&z={z}&x={x}&y={y}`;

            layerAtiva = L.tileLayer(url, { opacity: 0.85, zIndex: 100 }).addTo(map);
            toggleMenu();
        }

        function toggleMenu() { document.getElementById('menu-lateral').classList.toggle('active'); }
        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }

        // Mantendo o clique no mapa
        map.on('click', async (e) => {
            const res = await fetch(`/api/clima-clique?lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
            const data = await res.json();
            document.getElementById('painel-content').innerHTML = `
                <h1>${data.geo.address.city || "Localiza√ß√£o"}</h1>
                <div class="temp-txt">${data.clima.current.temperature_2m.toFixed(1)}¬∞C</div>
            `;
            document.getElementById('painel-full').classList.add('active');
        });
    </script>
</body>
</html>
