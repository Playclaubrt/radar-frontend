<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor Clima Global</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <button id="btn-menu-lateral" onclick="toggleMenu()">â˜°</button>

    <div id="menu-lateral-65">
        <button class="btn-fechar-menu" onclick="toggleMenu()">âœ•</button>
        <div class="conteudo-menu">
            <button class="btn-menu-item" onclick="toggleInterfaceCamadas()">MultiCamadas (30)</button>
        </div>
    </div>

    <div id="interface-camadas">
        <div class="quadrado-camadas">
            <button class="btn-camada-fechar" style="position:absolute; top:10px; right:10px; background:#ff4c4c; color:white; border:none; border-radius:5px; padding:5px 10px;" onclick="toggleInterfaceCamadas()">âœ•</button>
            <h3 style="color:#00ff99; text-align:center;">Selecione a Camada</h3>
            <div id="lista-botoes-camadas" class="btn-layer-grid"></div>
        </div>
    </div>

    <div id="search-container">
        <input type="text" id="cityInput" placeholder="Pesquisar cidade...">
        <button onclick="buscar()">ğŸ”</button>
    </div>

    <div id="map"></div>

    <div id="painel-full">
        <button class="btn-fechar-full" onclick="fecharPainel()">âœ•</button>
        <div id="conteudo-full" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const bounds = L.latLngBounds(L.latLng(-89.9, -180), L.latLng(89.9, 180));
        const map = L.map('map', { 
            zoomControl: false, minZoom: 2, maxBounds: bounds, maxBoundsViscosity: 1.0 
        }).setView([-15.7938, -47.8827], 4);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { noWrap: true, bounds: bounds }).addTo(map);

        let alertasGlobais = { inmet: [], noaa: [] };
        let layerAtiva = null;

        // --- AS 30 CAMADAS ---
        const listaCamadas = [
            { id: 'radar', n: 'Radar Vivo', e: 'ğŸ“¡', p: 'rv' },
            { id: 'precipitation_new', n: 'Chuva 1h', e: 'ğŸŒ§ï¸', p: 'owm' },
            { id: 'clouds_new', n: 'SatÃ©lite', e: 'â˜ï¸', p: 'owm' },
            { id: 'temp_new', n: 'Temp. Ar', e: 'ğŸŒ¡ï¸', p: 'owm' },
            { id: 'wind_new', n: 'Vento', e: 'ğŸƒ', p: 'owm' },
            { id: 'pressure_new', n: 'PressÃ£o', e: 'â²ï¸', p: 'owm' },
            { id: 'apparent_temperature', n: 'SensaÃ§Ã£o', e: 'ğŸ¥µ', p: 'om' },
            { id: 'relative_humidity_2m', n: 'Umidade', e: 'ğŸ’§', p: 'om' },
            { id: 'uv_index', n: 'Ãndice UV', e: 'â˜€ï¸', p: 'om' },
            { id: 'cape', n: 'Energia Raios', e: 'âš¡', p: 'om' },
            { id: 'visibility', n: 'Visibilidade', e: 'ğŸ‘ï¸', p: 'om' },
            { id: 'pm2_5', n: 'PoluiÃ§Ã£o Ar', e: 'ğŸŒ«ï¸', p: 'om_air' },
            { id: 'wave_height', n: 'Ondas Mar', e: 'ğŸŒŠ', p: 'om_marine' },
            { id: 'soil_moisture_0_1cm', n: 'Umidade Solo', e: 'ğŸŒ±', p: 'om' },
            { id: 'snow', n: 'Neve', e: 'â„ï¸', p: 'owm' },
            { id: 'carbon_monoxide', n: 'MonÃ³xido CO', e: 'ğŸ­', p: 'om_air' },
            { id: 'dust', n: 'Poeira/Dust', e: 'ğŸœï¸', p: 'om_air' },
            { id: 'ocean_currents', n: 'Correntes', e: 'ğŸ”„', p: 'om_marine' },
            { id: 'sea_surface_temperature', n: 'Temp. Mar', e: 'ğŸŒ…', p: 'om_marine' },
            { id: 'wind_gusts_10m', n: 'Rajadas', e: 'ğŸŒ¬ï¸', p: 'om' },
            { id: 'freezing_level_height', n: 'NÃ­vel Gelo', e: 'ğŸ”ï¸', p: 'om' },
            { id: 'evapotranspiration', n: 'EvaporaÃ§Ã£o', e: 'ğŸ‚', p: 'om' },
            { id: 'soil_temperature_0cm', n: 'Temp. Solo', e: 'ğŸŒ', p: 'om' },
            { id: 'surface_pressure', n: 'PressÃ£o Local', e: 'ğŸ“ˆ', p: 'om' },
            { id: 'cloud_ceiling', n: 'Teto Nuvens', e: 'ğŸ›«', p: 'om' },
            { id: 'lifted_index', n: 'Estabilidade', e: 'ğŸŒªï¸', p: 'om' },
            { id: 'convective_precipitation', n: 'Tempestades', e: 'â›ˆï¸', p: 'om' },
            { id: 'heat_index', n: 'Ãndice Calor', e: 'ğŸ”¥', p: 'om' },
            { id: 'ice_thickness', n: 'Gelo Espes.', e: 'â›¸ï¸', p: 'om_marine' },
            { id: 'pollen_birch', n: 'PÃ³len', e: 'ğŸŒ»', p: 'om_air' }
        ];

        // Criar botÃµes das camadas
        const containerCamadas = document.getElementById('lista-botoes-camadas');
        listaCamadas.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'btn-camada';
            btn.innerHTML = `${c.e} ${c.n}`;
            btn.onclick = () => {
                if(layerAtiva) map.removeLayer(layerAtiva);
                let url = c.p === 'rv' ? "https://tilecache.rainviewer.com/v2/radar/nowcast_5/256/{z}/{x}/{y}/2/1_1.png" :
                          c.p === 'owm' ? `https://tile.openweathermap.org/map/${c.id}/{z}/{x}/{y}.png?appid=79e72ce9f0e1cf547285186b5b54687d` :
                          `https://maps.open-meteo.com/v1/forecast?layers=${c.id}&format=tile&z={z}&x={x}&y={y}`;
                layerAtiva = L.tileLayer(url, { opacity: 0.7 }).addTo(map);
                toggleInterfaceCamadas();
            };
            containerCamadas.appendChild(btn);
        });

        function toggleMenu() { document.getElementById('menu-lateral-65').classList.toggle('menu-active'); }
        function toggleInterfaceCamadas() { document.getElementById('interface-camadas').classList.toggle('camadas-active'); }

        function getClimaEmoji(code) {
            const tab = { 0: "ğŸŒ", 1: "ğŸŒ¤ï¸", 2: "â›…", 3: "ğŸŒ¥ï¸", 45: "â˜ï¸", 61: "ğŸŒ§ï¸", 71: "ğŸŒ¨ï¸", 95: "â›ˆï¸" };
            return tab[code] || "ğŸŒ¡ï¸";
        }

        map.on('click', async function(e) {
            const { lat, lng } = e.latlng;
            abrirPainelFull("<h3>Buscando dados...</h3>", "#001a33");
            try {
                const res = await fetch(`/api/clima-clique?lat=${lat}&lon=${lng}`);
                const data = await res.json();
                const cur = data.clima.current;
                const dai = data.clima.daily;
                
                let prevHTML = `<div class='semana-grid'>`;
                dai.time.forEach((t, i) => {
                    const d = new Date(t + 'T00:00');
                    prevHTML += `<div style='min-width: 70px; text-align:center;'><b>${d.getDate()}/${d.getMonth()+1}</b><br>${getClimaEmoji(dai.weather_code[i])}</div>`;
                });
                prevHTML += `</div>`;

                let html = `
                    <h1 style="margin-bottom:5px;">${data.geo.address.city || data.geo.address.town || "LocalizaÃ§Ã£o"}</h1>
                    <div class="temp-principal">${cur.temperature_2m.toFixed(1)}Â°C</div>
                    <div class="emoji-grande">${getClimaEmoji(cur.weather_code)}</div>
                    ${prevHTML}
                    <div class="info-grid">
                        <div class="info-card">ğŸ’§ Humidade<br><b>${cur.relative_humidity_2m}%</b></div>
                        <div class="info-card">ğŸƒ Ar (AQI)<br><b>${data.ar.current.european_aqi}</b></div>
                        <div class="info-card">â²ï¸ PressÃ£o<br><b>${cur.pressure_msl}hPa</b></div>
                        <div class="info-card">ğŸ‘ï¸ Visib.<br><b>${(cur.visibility / 1000).toFixed(1)}km</b></div>
                        <div class="info-card">ğŸŒ… Nascer<br><b>${dai.sunrise[0].split('T')[1]}</b></div>
                        <div class="info-card">ğŸŒ‡ PÃ´r Sol<br><b>${dai.sunset[0].split('T')[1]}</b></div>
                    </div>
                `;
                abrirPainelFull(html, cur.temperature_2m > 30 ? "linear-gradient(180deg, #ff4e50 0%, #f9d423 100%)" : "linear-gradient(180deg, #2193b0 0%, #6dd5ed 100%)");
            } catch (err) { abrirPainelFull("<h2>Erro ao carregar</h2>", "#e74c3c"); }
        });

        async function carregarAlertas() {
            const res = await fetch('/api/alertas');
            alertasGlobais = await res.json();
            const iconInmet = L.divIcon({ html: '<div style="font-size:30px;">ğŸ”…</div>', className: 'c-icon' });
            const iconNoaa = L.divIcon({ html: '<div style="font-size:30px;">â˜ï¸</div>', className: 'c-icon' });

            if (alertasGlobais.inmet.length > 0) L.marker([-15.79, -47.88], {icon: iconInmet}).addTo(map).on('click', () => exibirAlertaLista(alertasGlobais.inmet, "INMET Brasil"));
            if (alertasGlobais.noaa.length > 0) L.marker([38.89, -77.03], {icon: iconNoaa}).addTo(map).on('click', () => exibirAlertaListaNoaa(alertasGlobais.noaa));
        }

        function abrirPainelFull(h, bg) {
            const p = document.getElementById('painel-full');
            p.style.background = bg;
            document.getElementById('conteudo-full').innerHTML = h;
            p.classList.add('active');
        }

        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }

        function exibirAlertaLista(lista, fonte) {
            let h = `<h2>${fonte}</h2><div style='text-align:left; width:100%'>`;
            lista.forEach(a => h += `<p><b>${a.title[0]}</b><br>${a.description[0]}</p><hr>`);
            h += `</div>`;
            abrirPainelFull(h, "#001a33");
        }

        function exibirAlertaListaNoaa(lista) {
            let h = `<h2>NOAA EUA</h2><div style='text-align:left; width:100%'>`;
            lista.forEach(a => h += `<p><b>${a.properties.event}</b><br>${a.properties.headline}</p><hr>`);
            h += `</div>`;
            abrirPainelFull(h, "#001a33");
        }

        async function buscar() {
            const v = document.getElementById('cityInput').value;
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${v}`);
            const d = await r.json();
            if(d.length > 0) map.setView([d[0].lat, d[0].lon], 10);
        }

        carregarAlertas();
    </script>
</body>
</html>
