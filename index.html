<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor Global Creator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <button id="btn-menu-lateral" onclick="toggleMenu()">â˜°</button>

    <div id="menu-lateral-65">
        <button class="btn-fechar-menu" onclick="toggleMenu()">âœ•</button>
        <div class="conteudo-menu">
            <button class="btn-camada-lateral" style="background:#fff; color:#000; justify-content:center;" onclick="toggleInterfaceCamadas()">Painel MultiCamadas (+)</button>
            <div id="lista-camadas-injetar"></div>
        </div>
    </div>

    <div id="interface-camadas">
        <div class="quadrado-camadas">
            <button style="position:absolute; top:10px; right:10px;" onclick="toggleInterfaceCamadas()">âœ•</button>
            <button class="btn-camada-add">ï¼‹</button>
        </div>
    </div>

    <div id="search-container">
        <input type="text" id="cityInput" placeholder="Pesquisar cidade...">
        <button onclick="buscar()">ğŸ”</button>
    </div>

    <div id="map"></div>

    <div id="painel-full">
        <button class="btn-fechar-full" onclick="fecharPainel()">âœ•</button>
        <div id="conteudo-full" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY_OWM = "7609a59c493758162d9b0a6af2914e1f";
        const bounds = L.latLngBounds(L.latLng(-89, -180), L.latLng(89, 180));
        
        const map = L.map('map', { 
            zoomControl: false, minZoom: 2, maxBounds: bounds, maxBoundsViscosity: 1.0 
        }).setView([-15.79, -47.88], 4);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { noWrap: true }).addTo(map);

        let layerAtiva = null;

        const camadas = [
            { id: 'infra', n: 'Infravermelho RealÃ§ado', e: 'ğŸ“¡', p: 'c', url: 'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/goes-ir-p90m.00/{z}/{x}/{y}.png' },
            { id: 'storm', n: 'Storm Chaser (Band 13)', e: 'ğŸŒªï¸', p: 'c', url: 'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/goes-conus-ch13/{z}/{x}/{y}.png' },
            { id: 'sat', n: 'SatÃ©lite Mundo Real', e: 'ğŸŒ', p: 'c', url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}' },
            { id: 'precipitation_new', n: 'Radar Chuva', e: 'ğŸŒ§ï¸', p: 'owm' },
            { id: 'clouds_new', n: 'Nuvens Reais', e: 'â˜ï¸', p: 'owm' },
            { id: 'temp_new', n: 'Temperatura Ar', e: 'ğŸŒ¡ï¸', p: 'owm' },
            { id: 'wind_new', n: 'Vento Global', e: 'ğŸƒ', p: 'owm' },
            { id: 'pressure_new', n: 'PressÃ£o Atmosf.', e: 'â²ï¸', p: 'owm' },
            { id: 'apparent_temperature', n: 'SensaÃ§Ã£o TÃ©rmica', e: 'ğŸ¥µ', p: 'om' },
            { id: 'cape', n: 'Energia (Raios)', e: 'âš¡', p: 'om' },
            { id: 'relative_humidity_2m', n: 'Umidade Rel.', e: 'ğŸ’§', p: 'om' },
            { id: 'uv_index', n: 'Ãndice UV', e: 'â˜€ï¸', p: 'om' },
            { id: 'visibility', n: 'Visibilidade', e: 'ğŸ‘ï¸', p: 'om' },
            { id: 'european_aqi', n: 'Qualidade do Ar', e: 'ğŸ˜·', p: 'om' },
            { id: 'pm2_5', n: 'PoluiÃ§Ã£o PM2.5', e: 'ğŸŒ«ï¸', p: 'om' },
            { id: 'dust', n: 'Poeira/Dust', e: 'ğŸœï¸', p: 'om' },
            { id: 'wave_height', n: 'Altura Ondas', e: 'ğŸŒŠ', p: 'om' },
            { id: 'ocean_currents', n: 'Correntes Mar.', e: 'ğŸ”„', p: 'om' },
            { id: 'sea_surface_temperature', n: 'Temp. Mar', e: 'ğŸŒ…', p: 'om' },
            { id: 'wind_gusts_10m', n: 'Rajadas Vento', e: 'ğŸŒ¬ï¸', p: 'om' },
            { id: 'soil_moisture_0_1cm', n: 'Umidade Solo', e: 'ğŸŒ±', p: 'om' },
            { id: 'snow_depth', n: 'Neve Acumulada', e: 'â„ï¸', p: 'om' },
            { id: 'carbon_monoxide', n: 'MonÃ³xido Carbono', e: 'ğŸ­', p: 'om' },
            { id: 'nitrogen_dioxide', n: 'DiÃ³xido NitrogÃªnio', e: 'ğŸš—', p: 'om' },
            { id: 'pollen_birch', n: 'PÃ³len (Alergia)', e: 'ğŸŒ»', p: 'om' },
            { id: 'freezing_level_height', n: 'NÃ­vel Gelo', e: 'ğŸ”ï¸', p: 'om' },
            { id: 'evapotranspiration', n: 'EvaporaÃ§Ã£o', e: 'ğŸ‚', p: 'om' },
            { id: 'soil_temperature_0cm', n: 'Temp. Solo', e: 'ğŸŒ', p: 'om' },
            { id: 'cloud_ceiling', n: 'Teto Nuvens', e: 'ğŸ›«', p: 'om' },
            { id: 'lifted_index', n: 'Instabilidade', e: 'ğŸŒªï¸', p: 'om' },
            { id: 'convective_precipitation', n: 'Chuva Tempestade', e: 'â›ˆï¸', p: 'om' },
            { id: 'heat_index', n: 'Ãndice Calor', e: 'ğŸ”¥', p: 'om' },
            { id: 'ice_thickness', n: 'Gelo Marinho', e: 'â›¸ï¸', p: 'om' }
        ];

        const container = document.getElementById('lista-camadas-injetar');
        camadas.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'btn-camada-lateral';
            btn.innerHTML = `<span>${c.e}</span> ${c.n}`;
            btn.onclick = () => {
                if(layerAtiva) map.removeLayer(layerAtiva);
                let url = c.p === 'c' ? c.url : 
                          c.p === 'owm' ? `https://tile.openweathermap.org/map/${c.id}/{z}/{x}/{y}.png?appid=${API_KEY_OWM}` :
                          `https://maps.open-meteo.com/v1/forecast?layers=${c.id}&format=tile&z={z}&x={x}&y={y}`;
                layerAtiva = L.tileLayer(url, { opacity: 0.75 }).addTo(map);
                toggleMenu();
            };
            container.appendChild(btn);
        });

        function toggleMenu() { document.getElementById('menu-lateral-65').classList.toggle('menu-active'); }
        function toggleInterfaceCamadas() { document.getElementById('interface-camadas').classList.toggle('camadas-active'); }
        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }

        function getEmoji(code) {
            const tab = { 0: "ğŸŒ", 1: "ğŸŒ¤ï¸", 2: "â›…", 3: "ğŸŒ¥ï¸", 45: "â˜ï¸", 61: "ğŸŒ§ï¸", 71: "ğŸŒ¨ï¸", 95: "â›ˆï¸" };
            return tab[code] || "ğŸŒ¡ï¸";
        }

        map.on('click', async (e) => {
            const { lat, lng } = e.latlng;
            document.getElementById('conteudo-full').innerHTML = "<h2>Buscando...</h2>";
            document.getElementById('painel-full').classList.add('active');
            
            try {
                const res = await fetch(`/api/clima-clique?lat=${lat}&lon=${lng}`);
                const data = await res.json();
                const cur = data.clima.current;
                const dai = data.clima.daily;

                let prevHTML = `<div class='semana-grid'>`;
                dai.time.forEach((t, i) => {
                    const d = new Date(t + 'T00:00');
                    prevHTML += `<div style='text-align:center;'><b>${d.getDate()}/${d.getMonth()+1}</b><br>${getEmoji(dai.weather_code[i])}</div>`;
                });
                prevHTML += `</div>`;

                document.getElementById('painel-full').style.background = cur.temperature_2m > 28 ? 
                    "linear-gradient(180deg, #ff4e50, #000)" : "linear-gradient(180deg, #2193b0, #000)";

                document.getElementById('conteudo-full').innerHTML = `
                    <h1>${data.geo.address.city || "LocalizaÃ§Ã£o"}</h1>
                    <div class="temp-principal">${cur.temperature_2m.toFixed(1)}Â°C</div>
                    <div style="font-size:80px;">${getEmoji(cur.weather_code)}</div>
                    ${prevHTML}
                    <div class="info-grid">
                        <div class="info-card">ğŸ’§ Umidade<br><b>${cur.relative_humidity_2m}%</b></div>
                        <div class="info-card">ğŸƒ Qualidade Ar<br><b>${data.ar.current.european_aqi}</b></div>
                        <div class="info-card">â²ï¸ PressÃ£o<br><b>${cur.pressure_msl}hPa</b></div>
                        <div class="info-card">ğŸ‘ï¸ Visib.<br><b>${(cur.visibility/1000).toFixed(1)}km</b></div>
                        <div class="info-card">ğŸŒ… Nascer<br><b>${dai.sunrise[0].split('T')[1]}</b></div>
                        <div class="info-card">ğŸŒ‡ PÃ´r Sol<br><b>${dai.sunset[0].split('T')[1]}</b></div>
                    </div>
                `;
            } catch (err) { fecharPainel(); }
        });

        async function buscar() {
            const v = document.getElementById('cityInput').value;
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${v}`);
            const d = await r.json();
            if(d[0]) map.setView([d[0].lat, d[0].lon], 10);
        }
    </script>
</body>
</html>
