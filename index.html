<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor Clima Global</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2 id="auth-title">LOGIN</h2>
            <input type="text" id="userInput" placeholder="Usu√°rio">
            <input type="password" id="passInput" placeholder="Senha">
            <button onclick="fazerAuth()" id="authBtn">ENTRAR</button>
            <p onclick="trocarModoAuth()" id="toggleAuth">Criar conta</p>
        </div>
    </div>

    <button id="btn-menu-lateral" onclick="toggleMenu()">‚ò∞</button>

    <div id="menu-lateral-65">
        <button class="btn-fechar-menu" onclick="toggleMenu()">‚úï</button>
        <div class="conteudo-menu">
            <div class="plano-tag">STATUS: <b id="userPlan">FREE</b></div>
            <button class="btn-menu-item" onclick="toggleInterfaceCamadas()">MultiCamadas</button>
            
            <div id="lista-camadas-infra">
                <button class="camada-btn-fixo" onclick="setBase('default')">DEFAULT (OSM)</button>
                <button class="camada-btn-fixo" onclick="setBase('satelite')">SAT√âLITE HD</button>
                <button class="camada-btn-fixo storm" onclick="setBase('storm')">STORM CHASER (BAND 13)</button>
                <div id="container-150">
                    </div>
            </div>
        </div>
    </div>

    <div id="interface-camadas">
        <div class="quadrado-camadas">
            <button class="btn-camada-fechar" onclick="toggleInterfaceCamadas()">‚úï</button>
            <button class="btn-camada-add" onclick="alert('Combinando Camadas...')">Ôºã</button>
            <p style="color: black; font-weight: bold;">COMBINAR CAMADAS</p>
        </div>
    </div>

    <div id="search-container">
        <input type="text" id="cityInput" placeholder="Pesquisar cidade...">
        <button onclick="buscar()">üîç</button>
    </div>

    <div id="map"></div>
    <div id="painel-full"><button class="btn-fechar-full" onclick="fecharPainel()">‚úï</button><div id="conteudo-full"></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY = "7609a59c493758162d9b0a6af2914e1f"; 
        const bounds = L.latLngBounds(L.latLng(-89.9, -180), L.latLng(89.9, 180));
        const map = L.map('map', { zoomControl: false, minZoom: 2, maxBounds: bounds, maxBoundsViscosity: 1.0 }).setView([-15.79, -47.88], 4);
        
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { noWrap: true }).addTo(map);
        const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        
        function setBase(t) {
            map.removeLayer(sat);
            document.getElementById('map').style.filter = "none";
            if(t==='satelite') sat.addTo(map);
            if(t==='storm') document.getElementById('map').style.filter = "invert(100%) grayscale(100%) brightness(0.5) contrast(1.5)";
        }

        function getClimaEmoji(code) {
            const tab = { 0: "üåû", 1: "üå§Ô∏è", 2: "‚õÖ", 3: "üå•Ô∏è", 45: "‚òÅÔ∏è", 61: "üåßÔ∏è", 71: "üå®Ô∏è", 95: "‚õàÔ∏è", 96: "üå©Ô∏è", 99: "üå™Ô∏è" };
            return tab[code] || "üå°Ô∏è";
        }

        // GERAR 150 CAMADAS
        const camNames = ["Refletividade Z", "Velocidade V", "MESH", "TVS", "CAPE", "SRH 0-3km", "VIL", "MESH", "Rain Rate", "Cloud Top", "Hotspots", "Dust", "PM2.5", "O3", "SO2"];
        const cont = document.getElementById('container-150');
        for(let i=0; i<150; i++) {
            let name = camNames[i % camNames.length] + " (Layer " + (i+1) + ")";
            cont.innerHTML += `<button class="camada-btn-lista" onclick="alert('Ativando ${name}')">${name}</button>`;
        }

        // L√ìGICA DE CLIQUE E ALERTAS (COPIADA DO SEU LAYOUT)
        map.on('click', async (e) => {
            const { lat, lng } = e.latlng;
            abrirPainelFull("<h3>Carregando...</h3>", "#000");
            const res = await fetch(`/api/clima-clique?lat=${lat}&lon=${lng}`);
            const data = await res.json();
            const current = data.clima.current;
            const daily = data.clima.daily;
            
            let html = `
                <h1>${data.geo.address.city || "Regi√£o"}</h1>
                <div class="temp-principal">${current.temperature_2m.toFixed(1)}¬∞C</div>
                <div class="emoji-grande" style="font-size:80px">${getClimaEmoji(current.weather_code)}</div>
                <div class="info-grid">
                    <div class="info-card">üíß Humid.<br><b>${current.relative_humidity_2m}%</b></div>
                    <div class="info-card">üçÉ Ar (AQI)<br><b>${data.ar.current.european_aqi}</b></div>
                    <div class="info-card">‚è≤Ô∏è Press√£o<br><b>${current.pressure_msl}hPa</b></div>
                    <div class="info-card">üëÅÔ∏è Visib.<br><b>${(current.visibility / 1000).toFixed(1)}km</b></div>
                </div>
                <div style="margin-top:20px; border-top:1px solid #fff; padding-top:10px;">
                    <p><b>Altitude:</b> ${current.weather_code > 90 ? '15.000m' : '3.000m'}</p>
                    <p><b>Evolu√ß√£o:</b> ${current.pressure_msl < 1010 ? 'CUMULOS -> SUPERCELULA' : 'EST√ÅVEL'}</p>
                </div>
            `;
            abrirPainelFull(html, current.temperature_2m > 30 ? "linear-gradient(180deg, #f5576c 0%, #f093fb 100%)" : "linear-gradient(180deg, #4facfe 0%, #00f2fe 100%)");
        });

        // AUTH
        let isLogin = true;
        function trocarModoAuth() { isLogin = !isLogin; document.getElementById('auth-title').innerText = isLogin ? "LOGIN" : "CADASTRO"; }
        async function fazerAuth() {
            const user = document.getElementById('userInput').value;
            const pass = document.getElementById('passInput').value;
            const res = await fetch(isLogin ? '/api/login' : '/api/cadastro', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user, pass}) });
            if(res.ok) {
                if(!isLogin) { alert("Cadastrado!"); trocarModoAuth(); }
                else { 
                    const d = await res.json(); 
                    document.getElementById('login-screen').style.display='none'; 
                    document.getElementById('userPlan').innerText = d.plan;
                }
            } else alert("Erro!");
        }

        function toggleMenu() { document.getElementById('menu-lateral-65').classList.toggle('menu-active'); }
        function toggleInterfaceCamadas() { document.getElementById('interface-camadas').classList.toggle('camadas-active'); }
        function abrirPainelFull(h, bg) { const p = document.getElementById('painel-full'); p.style.background = bg; document.getElementById('conteudo-full').innerHTML = h; p.classList.add('active'); }
        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }
    </script>
</body>
</html>
