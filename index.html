<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaser Monitor v3</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="search-container">
        <input type="text" id="input-busca" placeholder="Pesquisar cidade...">
        <button onclick="buscarLocalizacao()">ğŸ”</button>
    </div>

    <div id="container-menu">
        <button id="btn-menu" onclick="toggleMenu()">â˜° CAMADAS</button>
        <button id="btn-alertas-master" onclick="ativarAlertasGerais()">ğŸ”… NOAA & INMET â˜ï¸</button>
    </div>

    <div id="menu-lateral">
        <button onclick="toggleMenu()" class="btn-fechar">âœ• FECHAR</button>
        <div class="cat-title">MONITORAMENTO</div>
        <button class="btn-layer" onclick="aplicarCamada('nuvens')">â˜ï¸ Nuvens (OWM)</button>
        <button class="btn-layer" onclick="aplicarCamada('tempestades')">â›ˆï¸ Tempestades (Radar)</button>
        <button class="btn-layer" onclick="aplicarCamada('satelite')">ğŸ›°ï¸ Mapa Real</button>
        <button class="btn-layer" onclick="aplicarCamada('vento')">ğŸŒ¬ï¸ Ventos (KM/H)</button>
        <button class="btn-layer" onclick="aplicarCamada('raios')">âš¡ Raios (CAPE)</button>
        <button class="btn-layer" onclick="aplicarCamada('default')">ğŸ—ºï¸ Mapa Base</button>
    </div>

    <div id="map"></div>
    <div id="legenda-vento" class="hidden"><div class="gradiente-vento"></div><span>0km/h --- 120km/h</span></div>

    <div id="painel-full">
        <button class="btn-close-full" onclick="fecharPainel()">âœ• FECHAR PAINEL</button>
        <div id="painel-content"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY_OWM = "SUA_API_KEY_AQUI"; // COLOQUE SUA CHAVE AQUI
        const map = L.map('map', { zoomControl: false }).setView([-15.79, -47.88], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let layerAtiva = null;
        let markersAlertas = [];

        async function ativarAlertasGerais() {
            markersAlertas.forEach(m => map.removeLayer(m));
            markersAlertas = [];

            const res = await fetch('/api/alertas');
            const data = await res.json();

            // Ãcone Brasil (BrasÃ­lia)
            const mBrasil = L.marker([-15.79, -47.88]).addTo(map).bindTooltip("INMET ğŸ”…", {permanent:true});
            mBrasil.on('click', () => abrirPainelAlerta('INMET BRASIL', data.inmet));
            markersAlertas.push(mBrasil);

            // Ãcone USA (Washington)
            const mUSA = L.marker([38.89, -77.03]).addTo(map).bindTooltip("NOAA â˜ï¸", {permanent:true});
            mUSA.on('click', () => abrirPainelAlerta('NOAA USA', data.noaa));
            markersAlertas.push(mUSA);

            alert("Alertas Ativados nas Capitais!");
        }

        function abrirPainelAlerta(fonte, lista) {
            let html = `<h1>${fonte}</h1>`;
            if(lista.length === 0) html += "<p>Nenhum alerta crÃ­tico no momento.</p>";
            lista.forEach(item => {
                html += `<div class="alerta-box"><h3>${item.title || item.properties.event}</h3><p>${item.description || item.properties.headline}</p></div><hr>`;
            });
            document.getElementById('painel-content').innerHTML = html;
            document.getElementById('painel-full').classList.add('active');
        }

        function aplicarCamada(tipo) {
            if(layerAtiva) map.removeLayer(layerAtiva);
            document.getElementById('legenda-vento').classList.add('hidden');
            let url = "";

            if(tipo === 'nuvens') url = `https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
            if(tipo === 'tempestades') url = 'https://tilecache.rainviewer.com/v2/radar/nowcast_5/256/{z}/{x}/{y}/2/1_1.png';
            if(tipo === 'satelite') url = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
            if(tipo === 'vento') { 
                url = 'https://maps.open-meteo.com/v1/forecast?layers=wind_speed_10m&format=tile&z={z}&x={x}&y={y}'; 
                document.getElementById('legenda-vento').classList.remove('hidden'); 
            }
            if(tipo === 'raios') url = 'https://maps.open-meteo.com/v1/forecast?layers=cape&format=tile&z={z}&x={x}&y={y}';
            
            if(url) layerAtiva = L.tileLayer(url, { opacity: 0.8, zIndex: 100 }).addTo(map);
            toggleMenu();
        }

        async function buscarLocalizacao() {
            const q = document.getElementById('input-busca').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
            const data = await res.json();
            if(data[0]) map.setView([data[0].lat, data[0].lon], 10);
        }

        function toggleMenu() { document.getElementById('menu-lateral').classList.toggle('active'); }
        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }

        map.on('click', async (e) => {
            const res = await fetch(`/api/clima-clique?lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
            const d = await res.json();
            document.getElementById('painel-content').innerHTML = `<h1>${d.geo.address.city || "Local"}</h1><div class="temp-txt">${d.clima.current.temperature_2m}Â°C</div>`;
            document.getElementById('painel-full').classList.add('active');
        });
    </script>
</body>
</html>
