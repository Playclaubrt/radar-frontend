<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaser Monitor v3</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="search-container">
        <input type="text" id="input-busca" placeholder="Pesquisar cidade...">
        <button onclick="buscarLocalizacao()">ğŸ”</button>
    </div>

    <div id="container-controles">
        <button id="btn-menu" onclick="toggleMenu()">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </button>
        <button id="btn-ativar-alertas" onclick="renderizarIconesNosMapas()">ğŸ”… ATIVAR ALERTAS â˜ï¸</button>
    </div>

    <div id="menu-lateral">
        <button onclick="toggleMenu()" class="btn-fechar">âœ•</button>
        <div class="cat-title">ATMOSFERA</div>
        <button class="btn-layer" onclick="aplicarCamada('clouds')">â˜ï¸ Nuvens Reais</button>
        <button class="btn-layer" onclick="aplicarCamada('infra')">ğŸŒ¡ï¸ Infravermelho</button>
        <div class="cat-title">RADAR</div>
        <button class="btn-layer" onclick="aplicarCamada('tempestades')">â›ˆï¸ Radar de Chuva</button>
        <button class="btn-layer" onclick="aplicarCamada('satelite_base')">ğŸ›°ï¸ SatÃ©lite</button>
    </div>

    <div id="map"></div>

    <div id="painel-full">
        <button class="btn-close-full" onclick="fecharPainel()" style="position:fixed; top:20px; right:20px; z-index:100000;">âœ•</button>
        <div id="painel-content"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY_OWM = "7609a59c493758162d9b0a6af2914e1f"; 

        const map = L.map('map', { 
            zoomControl: false, 
            attributionControl: false,
            minZoom: 3,
            maxZoom: 18
        }).setView([-22.12, -51.38], 10);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let camadaAtual = 'default';
        let layerAtiva = null;
        let markersAlertas = [];

        function aplicarCamada(tipo) {
            camadaAtual = tipo;
            if(layerAtiva) map.removeLayer(layerAtiva);
            
            let url = "";
            if(tipo === 'clouds') url = `https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
            if(tipo === 'infra') url = `https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
            if(tipo === 'tempestades') url = `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${API_KEY_OWM}`;
            // MUDADO PARA GOOGLE SATELLITE (MAIS CONFIÃVEL)
            if(tipo === 'satelite_base') url = 'http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}';

            if(url) {
                layerAtiva = L.tileLayer(url, { 
                    opacity: 0.85, 
                    zIndex: 100,
                    subdomains:['mt0','mt1','mt2','mt3'] 
                }).addTo(map);
            }
            toggleMenu();
        }

        // CLIQUE NO MAPA CORRIGIDO
        map.on('click', async (e) => {
            const { lat, lng } = e.latlng;
            
            try {
                const res = await fetch(`/api/clima-clique?lat=${lat}&lon=${lng}`);
                const d = await res.json();
                
                if(!d.clima) return;

                const painel = document.getElementById('painel-full');
                const content = document.getElementById('painel-content');

                let analise = `<div class="analise-box"><h2>ANÃLISE DE CAMADA: ${camadaAtual.toUpperCase()}</h2>`;
                if(camadaAtual === 'tempestades') analise += `<p>PrecipitaÃ§Ã£o: ${d.clima.current.rain ? d.clima.current.rain['1h'] : '0.0'} mm/s</p>`;
                if(camadaAtual === 'infra') analise += `<p>Vento: ${d.clima.current.wind_speed} km/h | DireÃ§Ã£o: ${d.clima.current.wind_deg}Â°</p>`;
                analise += `</div>`;

                content.innerHTML = `
                    <div class="clima-section" style="padding: 60px 20px; text-align: center;">
                        <h1>${d.geo.address.city || "LocalizaÃ§Ã£o"}</h1>
                        <div class="temp-val" style="font-size: 8rem; font-weight: bold; color: #00ff99;">${Math.round(d.clima.current.temp)}Â°C</div>
                        <div class="clima-grid">
                            <div class="c-item">ğŸ’§ Umidade: ${d.clima.current.humidity}%</div>
                            <div class="c-item">ğŸŒ¬ï¸ Vento: ${d.clima.current.wind_speed} km/h</div>
                            <div class="c-item">â²ï¸ PressÃ£o: ${d.clima.current.pressure} hPa</div>
                            <div class="c-item">ğŸŒ… Sol: ${new Date(d.clima.current.sunset * 1000).toLocaleTimeString()}</div>
                        </div>
                        ${analise}
                    </div>
                `;
                painel.className = 'clima-view active';
            } catch (err) { console.log("Erro silencioso no clique"); }
        });

        async function renderizarIconesNosMapas() {
            try {
                const res = await fetch('/api/alertas');
                const data = await res.json();
                
                markersAlertas.forEach(m => map.removeLayer(m));

                const icon1 = L.divIcon({html:'ğŸ”…', className:'map-icon', iconSize:[40,40]});
                const mInmet = L.marker([-15.79, -47.88], {icon: icon1}).addTo(map);
                mInmet.on('click', () => {
                    abrirAlertaRapido('INMET BRASIL', data.inmet);
                });

                const icon2 = L.divIcon({html:'â˜ï¸', className:'map-icon', iconSize:[40,40]});
                const mNoaa = L.marker([38.89, -77.03], {icon: icon2}).addTo(map);
                mNoaa.on('click', () => {
                    abrirAlertaRapido('NOAA USA', data.noaa);
                });

                markersAlertas.push(mInmet, mNoaa);
            } catch(e) {}
        }

        function abrirAlertaRapido(titulo, lista) {
            const content = document.getElementById('painel-content');
            let h = `<h1>${titulo}</h1>`;
            lista.forEach(i => {
                h += `<div class="analise-box"><h3>${i.title || i.properties.event}</h3><p>${i.description || i.properties.headline}</p></div>`;
            });
            content.innerHTML = h;
            document.getElementById('painel-full').className = 'alerta-view active';
        }

        function toggleMenu() { document.getElementById('menu-lateral').classList.toggle('active'); }
        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }

        async function buscarLocalizacao() {
            const q = document.getElementById('input-busca').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
            const data = await res.json();
            if(data[0]) map.setView([data[0].lat, data[0].lon], 11);
        }
    </script>
</body>
</html>
