<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Storm Chaser Ultra Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2>ACESSAR STORM CHASER</h2>
            <input type="text" id="userInput" placeholder="Usu√°rio">
            <input type="password" id="passInput" placeholder="Senha">
            <button onclick="fazerLogin()">ENTRAR</button>
        </div>
    </div>

    <div id="top-bar">
        <div id="search-container">
            <input type="text" id="cityInput" placeholder="Pesquisar cidade...">
            <button onclick="buscarCidade()">üîç</button>
        </div>
        <button id="btn-menu-lateral" onclick="toggleMenu()">‚ò∞</button>
    </div>

    <div id="menu-lateral-65">
        <button class="btn-fechar-menu" onclick="toggleMenu()">‚úï</button>
        <div class="conteudo-menu">
            <div class="user-info">PLANO: <span id="userPlan">FREE</span></div>
            <button class="btn-menu-item" onclick="setCamada('Default')">Padr√£o (IR)</button>
            <button class="btn-menu-item" onclick="setCamada('Satelite')">Sat√©lite HD</button>
            <button class="btn-menu-item storm-btn" onclick="setCamada('StormChaser')">STORM CHASER (BAND 13)</button>
            <button class="btn-menu-item" onclick="toggleLayer('raios')">üì° Detec√ß√£o de Raios</button>
            <button class="btn-menu-item" onclick="toggleLayer('vento')">üí® Vetores de Vento</button>
            <button class="btn-menu-item" onclick="abrirPlanos()">üíé UPGRADE PARA ULTRA PRO</button>
        </div>
    </div>

    <div id="map"></div>
    <div id="painel-full"><button class="btn-fechar-full" onclick="fecharPainel()">‚úï</button><div id="conteudo-full" class="scroll-area"></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY = "SUA_API_KEY";
        const map = L.map('map', { zoomControl: false, minZoom: 2, maxBounds: [[-90,-180],[90,180]] }).setView([-15,-47], 4);
        
        const layers = {
            base: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map),
            sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
            ir: L.tileLayer(`https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${API_KEY}`, {opacity: 0.9}),
            raios: L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${API_KEY}`),
            vento: L.tileLayer(`https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=${API_KEY}`)
        };

        let modoStorm = false;
        let camadaAlertas = L.layerGroup().addTo(map);

        function setCamada(tipo) {
            Object.values(layers).forEach(l => map.removeLayer(l));
            layers.base.addTo(map);
            const container = map.getContainer();
            container.style.filter = "none";

            if(tipo === 'StormChaser') {
                layers.ir.addTo(map);
                container.style.filter = "invert(100%) grayscale(100%) brightness(0.4) contrast(1.6)";
                modoStorm = true;
            } else if(tipo === 'Satelite') {
                layers.sat.addTo(map);
                modoStorm = false;
            } else {
                layers.ir.addTo(map);
                modoStorm = false;
            }
            toggleMenu();
        }

        async function processarClique(lat, lon) {
            const res = await fetch(`/api/clima?lat=${lat}&lon=${lon}`);
            const data = await res.json();
            const c = data.clima.current;
            const d = data.clima.daily;
            const local = data.geo.address.city || "Alvo Desconhecido";

            let h = `
                <h1>${local}</h1>
                <div class="temp-principal">${Math.round(c.temperature_2m)}¬∞C</div>
                <div class="info-grid">
                    <div class="info-card">Visibilidade: <b>${(c.visibility/1000).toFixed(1)}km</b></div>
                    <div class="info-card">P√¥r do Sol: <b>${d.sunset[0].split('T')[1]}</b></div>
                    <div class="info-card">Press√£o: <b>${c.pressure_msl}hPa</b></div>
                    <div class="info-card">Vento: <b>${c.wind_speed_10m}km/h</b></div>
                </div>`;

            if(modoStorm) {
                h += `
                <div class="analise-goes">
                    <h3>AN√ÅLISE BAND 13 (REAL-TIME)</h3>
                    <p><b>Nome:</b> ${local}</p>
                    <p><b>Tipo:</b> ${c.weather_code > 90 ? 'Cumulonimbus Incus' : 'Altocumulus'}</p>
                    <p><b>Altitude:</b> ${c.weather_code > 90 ? '12.000m+' : '3.000m'}</p>
                    <p><b>Evolu√ß√£o:</b> ${c.pressure_msl < 1005 ? 'C√©lula -> Superc√©lula' : 'Est√°vel'}</p>
                    <p><b>Data:</b> ${new Date().toLocaleString()}</p>
                </div>`;
            }
            abrirPainelFull(h, "#001a33");
        }

        map.on('click', e => processarClique(e.latlng.lat, e.latlng.lng));

        // LOGIN E PAGAMENTO
        async function fazerLogin() {
            const user = document.getElementById('userInput').value;
            const pass = document.getElementById('passInput').value;
            const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user, pass}) });
            const data = await res.json();
            if(data.success) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('userPlan').innerText = data.plan;
            } else alert("Erro de Login");
        }

        function abrirPlanos() {
            abrirPainelFull(`
                <h2>PLANOS STORM CHASER</h2>
                <div class="plano-box">PREMIUM: R$ 29/m√™s</div>
                <div class="plano-box">PRO: R$ 59/m√™s</div>
                <div class="plano-box ultra">ULTRA PRO: R$ 99/m√™s</div>
                <button class="pay-btn">PAGAR COM PIX / CART√ÉO</button>
            `, "#050505");
        }

        function toggleMenu() { document.getElementById('menu-lateral-65').classList.toggle('menu-active'); }
        function abrirPainelFull(h, bg) { document.getElementById('painel-full').style.background = bg; document.getElementById('conteudo-full').innerHTML = h; document.getElementById('painel-full').classList.add('active'); }
        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }
        function toggleLayer(name) { map.hasLayer(layers[name]) ? map.removeLayer(layers[name]) : layers[name].addTo(map); }
    </script>
</body>
</html>
