<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Monitor Global - Chaser Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <button id="btn-menu-lateral" onclick="toggleMenu()">‚ò∞</button>
    <div id="menu-lateral-65">
        <button onclick="toggleMenu()" style="color:#00ff99; background:none; border:none; font-size:30px; position:absolute; top:20px; left:20px;">‚úï</button>
        <h3 style="color:white; margin-bottom:20px;">CENTRAL DE CAMADAS</h3>
        <div id="lista-camadas"></div>
    </div>

    <div id="search-container">
        <input type="text" id="cityInput" placeholder="Cidades...">
        <button onclick="buscar()">üîç</button>
    </div>

    <div id="map"></div>

    <div id="painel-full">
        <button onclick="fecharPainel()" style="position:absolute; top:20px; right:20px; color:white; background:rgba(0,0,0,0.5); border:none; padding:10px; border-radius:50%;">‚úï</button>
        <div id="conteudo-full" style="text-align:center; width:100%;"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY = "7609a59c493758162d9b0a6af2914e1f";
        const map = L.map('map', { zoomControl: false }).setView([-15, -48], 4);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let layerAtiva = null;

        // --- AS 33 CAMADAS (CHASER + BAND 13 + OUTRAS) ---
        const camadas = [
            { id: 'storm', n: 'Storm Chaser Layer', e: 'üå™Ô∏è', p: 'c', url: 'https://tilecache.rainviewer.com/v2/radar/nowcast_5/256/{z}/{x}/{y}/2/1_1.png' },
            { id: 'band13', n: 'Band 13 (Clean IR)', e: 'üì°', p: 'c', url: 'https://realearth.ssec.wisc.edu/tiles/GOES-East-ABI-Geo-Band13/{z}/{x}/{y}.png' },
            { id: 'infra', n: 'Infravermelho Real√ßado', e: 'üõ∞Ô∏è', p: 'c', url: 'https://tilecache.rainviewer.com/v2/satellite/nowcast/256/{z}/{x}/{y}/1/1_1.png' },
            { id: 'sat', n: 'Sat√©lite Mundo Real', e: 'üåç', p: 'c', url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}' },
            { id: 'precipitation_new', n: 'Radar de Chuva', e: 'üåßÔ∏è', p: 'owm' },
            { id: 'clouds_new', n: 'Nuvens Reais', e: '‚òÅÔ∏è', p: 'owm' },
            { id: 'temp_new', n: 'Temperatura Ar', e: 'üå°Ô∏è', p: 'owm' },
            { id: 'wind_new', n: 'Vento Global', e: 'üçÉ', p: 'owm' },
            { id: 'pressure_new', n: 'Press√£o Atmosf.', e: '‚è≤Ô∏è', p: 'owm' },
            { id: 'apparent_temperature', n: 'Sensa√ß√£o T√©rmica', e: 'ü•µ', p: 'om' },
            { id: 'cape', n: 'Energia (CAPE)', e: '‚ö°', p: 'om' },
            { id: 'relative_humidity_2m', n: 'Umidade', e: 'üíß', p: 'om' },
            { id: 'uv_index', n: '√çndice UV', e: '‚òÄÔ∏è', p: 'om' },
            { id: 'visibility', n: 'Visibilidade', e: 'üëÅÔ∏è', p: 'om' },
            { id: 'wave_height', n: 'Altura Ondas', e: 'üåä', p: 'om' },
            { id: 'pm2_5', n: 'Polui√ß√£o PM2.5', e: 'üå´Ô∏è', p: 'om' },
            { id: 'dust', n: 'Poeira/Dust', e: 'üèúÔ∏è', p: 'om' },
            { id: 'wind_gusts_10m', n: 'Rajadas Vento', e: 'üå¨Ô∏è', p: 'om' },
            { id: 'ocean_currents', n: 'Correntes Mar.', e: 'üîÑ', p: 'om' },
            { id: 'sea_surface_temperature', n: 'Temp. Mar', e: 'üåÖ', p: 'om' },
            { id: 'carbon_monoxide', n: 'Mon√≥xido Carbono', e: 'üè≠', p: 'om' },
            { id: 'nitrogen_dioxide', n: 'Di√≥xido Nitrog√™nio', e: 'üöó', p: 'om' },
            { id: 'pollen_birch', n: 'P√≥len', e: 'üåª', p: 'om' },
            { id: 'soil_moisture_0_1cm', n: 'Umidade Solo', e: 'üå±', p: 'om' },
            { id: 'snow_depth', n: 'Neve', e: '‚ùÑÔ∏è', p: 'om' },
            { id: 'ice_thickness', n: 'Gelo Marinho', e: '‚õ∏Ô∏è', p: 'om' },
            { id: 'freezing_level_height', n: 'N√≠vel Gelo', e: 'üèîÔ∏è', p: 'om' },
            { id: 'evapotranspiration', n: 'Evapora√ß√£o', e: 'üçÇ', p: 'om' },
            { id: 'soil_temperature_0cm', n: 'Temp. Solo', e: 'üåç', p: 'om' },
            { id: 'cloud_ceiling', n: 'Teto Nuvens', e: 'üõ´', p: 'om' },
            { id: 'lifted_index', n: 'Instabilidade', e: 'üå™Ô∏è', p: 'om' },
            { id: 'convective_precipitation', n: 'Tempestades', e: '‚õàÔ∏è', p: 'om' },
            { id: 'heat_index', n: '√çndice Calor', e: 'üî•', p: 'om' }
        ];

        const container = document.getElementById('lista-camadas');
        camadas.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'btn-camada';
            btn.innerHTML = `<span>${c.e}</span> ${c.n}`;
            btn.onclick = () => {
                if(layerAtiva) map.removeLayer(layerAtiva);
                let url = c.p === 'c' ? c.url : 
                          c.p === 'owm' ? `https://tile.openweathermap.org/map/${c.id}/{z}/{x}/{y}.png?appid=${API_KEY}` :
                          `https://maps.open-meteo.com/v1/forecast?layers=${c.id}&format=tile&z={z}&x={x}&y={y}`;
                layerAtiva = L.tileLayer(url, { opacity: 1, zIndex: 10 }).addTo(map);
                toggleMenu();
            };
            container.appendChild(btn);
        });

        function toggleMenu() { document.getElementById('menu-lateral-65').classList.toggle('menu-active'); }
        function fecharPainel() { document.getElementById('painel-full').classList.remove('active'); }

        async function carregarAlertas() {
            try {
                const res = await fetch('/api/alertas');
                const data = await res.json();
                const btnMenu = document.getElementById('btn-menu-lateral');

                // Ativa Alarme Visual se houver perigo severo
                if(data.temPerigo) {
                    btnMenu.classList.add('alerta-ativo');
                    console.log("ALERTA SEVERO DETECTADO!");
                } else {
                    btnMenu.classList.remove('alerta-ativo');
                }

                const iconInmet = L.divIcon({ html: '<div style="font-size:30px; text-shadow:0 0 10px gold;">üîÖ</div>', className: 'a' });
                const iconNoaa = L.divIcon({ html: '<div style="font-size:30px; text-shadow:0 0 10px cyan;">‚òÅÔ∏è</div>', className: 'a' });

                if(data.inmet.length) L.marker([-15.79, -47.88], {icon: iconInmet}).addTo(map).on('click', () => abrirPainelFull("<h3>INMET Brasil</h3>" + data.inmet[0].description[0], "#001a33"));
                if(data.noaa.length) L.marker([38.89, -77.03], {icon: iconNoaa}).addTo(map).on('click', () => abrirPainelFull("<h3>NOAA EUA</h3>" + data.noaa[0].properties.headline, "#001a33"));
            } catch(e) {}
        }

        map.on('click', async (e) => {
            const res = await fetch(`/api/clima-clique?lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
            const data = await res.json();
            const cur = data.clima.current;
            let html = `<h1>${data.geo.address.city || "Regi√£o"}</h1><div class="temp-principal">${cur.temperature_2m}¬∞C</div>`;
            abrirPainelFull(html, cur.temperature_2m > 30 ? "linear-gradient(#f00, #000)" : "linear-gradient(#00f, #000)");
        });

        function abrirPainelFull(h, bg) {
            const p = document.getElementById('painel-full');
            p.style.background = bg;
            document.getElementById('conteudo-full').innerHTML = h;
            p.classList.add('active');
        }

        async function buscar() {
            const v = document.getElementById('cityInput').value;
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${v}`);
            const d = await r.json();
            if(d[0]) map.setView([d[0].lat, d[0].lon], 10);
        }

        setInterval(carregarAlertas, 60000);
        carregarAlertas();
    </script>
</body>
</html>
